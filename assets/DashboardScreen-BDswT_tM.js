import{u as I,r as o,j as e,c as d}from"./index-DUV06g7s.js";import{Q as R}from"./browser-6ioanZY4.js";import{v as T}from"./fileValidation-Bv-3PqZU.js";const U="http://localhost:5000/api",y=U.replace("/api","");function L(){const n=I(),[a,g]=o.useState(null),[N,k]=o.useState(!0),[u,m]=o.useState({}),[f,v]=o.useState(!1),[p,w]=o.useState(""),[r,S]=o.useState(null);o.useEffect(()=>{(async()=>{try{console.log("ðŸ” DashboardScreen: fetchUserData called");const s=await d.getCurrentUser();if(console.log("ðŸ” DashboardScreen: API response:",s),s.success){g(s.user),console.log("ðŸ” Fetching active booking from Bookings API...");try{const i=await d.request("/booking/user/active");console.log("ðŸ” Booking API response:",i);const c=(i.success?i.data:[])?.find(h=>h.paymentStatus==="cash_pending");if(c){console.log("ðŸ”„ Found cash_pending booking, redirecting..."),n("/cash-payment-pending",{state:{bookingData:c},replace:!0});return}else console.log("ðŸ” No cash_pending booking found")}catch(i){console.log("ðŸ” Booking API error (non-critical):",i.message),console.log("ðŸ” Continuing to dashboard without active booking check")}s.user.hasDnyanpittId&&await D()}else throw new Error("Failed to fetch user data")}catch(s){console.error("Error loading user data:",s),d.removeToken(),n("/",{replace:!0})}finally{k(!1)}})()},[]);const D=async()=>{try{const t=await d.request("/booking/check-eligibility");t.success&&S(t.data)}catch(t){console.error("Error checking membership eligibility:",t)}},A=()=>{r?.canCreateNewMembership?n("/membership",{replace:!0}):r?.hasActiveMembership&&alert("You already have an active membership. Only one active membership is allowed at a time.")},P=async t=>{const s=t.target.files[0];if(!s)return;const i=T(s,"AVATAR");if(!i.isValid){m(l=>({...l,profilePicture:i.error})),t.target.value="";return}m(l=>({...l,profilePicture:""}));try{const l=await d.uploadAvatar(s);l.success?g(l.user):m(c=>({...c,profilePicture:l.message||"Failed to upload avatar"}))}catch(l){console.error("Error uploading avatar:",l),m(c=>({...c,profilePicture:l.message||"Error uploading avatar. Please try again."}))}},j=()=>{v(!0)};o.useEffect(()=>{v(!1)},[a?.avatar]),o.useEffect(()=>{a&&r?.hasActiveMembership&&r?.activeBookings?.length>0&&C(a,r.activeBookings[0])},[r?.hasActiveMembership,a?.dyanpittId,a?.fullName]);const C=async(t,s)=>{try{const i={type:"MEMBERSHIP_PASS",id:t.dyanpittId||t.email,name:t.fullName,email:t.email,membership:s.membershipType,timeSlot:s.timeSlot,validFrom:s.membershipStartDate,validUntil:s.membershipEndDate,seat:s.preferredSeat||"Any",generatedAt:new Date().toISOString(),status:"active"},l=await R.toDataURL(JSON.stringify(i),{width:200,margin:2,color:{dark:"#000000",light:"#FFFFFF"}});w(l)}catch(i){console.error("Error generating QR code:",i)}},E=async()=>{if(!(!p||!a))try{const t=document.createElement("canvas"),s=t.getContext("2d");t.width=800,t.height=1200,s.fillStyle="#ffffff",s.fillRect(0,0,t.width,t.height),s.fillStyle="#1e293b",s.font="bold 32px Arial",s.textAlign="center",s.fillText("DYANPITT MEMBERSHIP PASS",t.width/2,60),s.font="18px Arial",s.fillStyle="#64748b",s.fillText("Study Room Access Pass",t.width/2,90);let i=150;s.fillStyle="#1e293b",s.font="bold 24px Arial",s.textAlign="left",s.fillText("Member Information",50,i),i+=40,s.font="16px Arial",s.fillStyle="#374151",[`Name: ${a.fullName}`,`Email: ${a.email}`,...a.dyanpittId?[`Dyanpeeth Abhyasika ID: ${a.dyanpittId}`]:[],...a.phoneNumber?[`Phone: ${a.phoneNumber}`]:[]].forEach(x=>{s.fillText(x,50,i),i+=25}),i+=20,s.fillStyle="#1e293b",s.font="bold 24px Arial",s.fillText("Membership Details",50,i),i+=40,s.font="16px Arial",s.fillStyle="#374151",[`Type: ${a.bookingDetails.membershipType}`,`Duration: ${a.bookingDetails.membershipDuration}`,`Time Slot: ${a.bookingDetails.timeSlot}`,`Valid From: ${new Date(a.bookingDetails.membershipStartDate).toLocaleDateString()}`,`Valid Until: ${new Date(a.bookingDetails.membershipEndDate).toLocaleDateString()}`,...a.bookingDetails.preferredSeat?[`Preferred Seat: ${a.bookingDetails.preferredSeat}`]:[],`Amount Paid: â‚¹${a.bookingDetails.totalAmount}`].forEach(x=>{s.fillText(x,50,i),i+=25}),i+=40;const h=new Image;h.onload=()=>{const B=(t.width-200)/2;s.drawImage(h,B,i,200,200),i+=230,s.fillStyle="#1e293b",s.font="bold 18px Arial",s.textAlign="center",s.fillText("Scan for Verification",t.width/2,i),i+=40,s.font="14px Arial",s.fillStyle="#64748b",s.fillText("Present this pass at the entrance for access",t.width/2,i),i+=20,s.fillText("Show QR code to staff for verification",t.width/2,i),i+=60,s.fillStyle="#9ca3af",s.font="12px Arial",s.fillText(`Generated on: ${new Date().toLocaleString()}`,t.width/2,i);const b=document.createElement("a");b.download=`dyanpitt-membership-pass-${a.dyanpittId||a.email}.png`,b.href=t.toDataURL(),b.click()},h.src=p}catch(t){console.error("Error generating membership pass:",t)}},M=async()=>{try{await d.logout(),n("/",{replace:!0})}catch{d.removeToken(),n("/",{replace:!0})}};return N?e.jsx("div",{className:"main-container",children:e.jsx("div",{className:"simple-loading",children:e.jsx("p",{children:"Loading..."})})}):e.jsxs("div",{className:"dashboard-container",children:[e.jsxs("div",{className:"dashboard-header",children:[e.jsx("div",{className:"profile-picture-container",children:e.jsx("div",{className:"profile-picture",children:a?.avatar&&!f?e.jsx("img",{src:`${y}${a.avatar}`,alt:"Profile",className:"dashboard-profile-image",onError:j,crossOrigin:"anonymous"}):a?.fullName?a.fullName.charAt(0).toUpperCase():"U"})}),e.jsxs("div",{className:"header-text-section",children:[e.jsx("div",{className:"welcome-message",children:"Welcome!"}),e.jsx("div",{className:"user-name",children:a?.fullName||"User"})]})]}),e.jsx("div",{className:"dashboard-content",children:e.jsxs("div",{className:"dashboard-welcome-section",children:[a&&e.jsxs("div",{className:"dashboard-user-card",children:[e.jsx("h3",{className:"user-card-title",children:"Your Account Details"}),e.jsxs("div",{className:"user-details",children:[e.jsxs("div",{className:"user-detail-item",children:[e.jsx("span",{className:"detail-label",children:"Full Name:"}),e.jsx("span",{className:"detail-value",children:a.fullName})]}),e.jsxs("div",{className:"user-detail-item",children:[e.jsx("span",{className:"detail-label",children:"Email:"}),e.jsx("span",{className:"detail-value",children:a.email})]}),e.jsxs("div",{className:"user-detail-item",children:[e.jsx("span",{className:"detail-label",children:"Dyanpeeth Abhyasika ID:"}),a.hasDnyanpittId?e.jsx("span",{className:"detail-value dyanpitt-id",children:a.dyanpittId}):e.jsx("span",{className:"detail-value pending-id",children:"Pending - Complete membership & payment to get your ID"})]}),a.phoneNumber&&e.jsxs("div",{className:"user-detail-item",children:[e.jsx("span",{className:"detail-label",children:"Phone:"}),e.jsx("span",{className:"detail-value",children:a.phoneNumber})]})]})]}),a&&e.jsxs("div",{className:"dashboard-membership-section",children:[e.jsx("h3",{className:"section-title",children:"Membership Status"}),e.jsx("div",{className:"membership-status-card",children:r?.hasActiveMembership&&r?.activeBookings?.length>0?e.jsxs("div",{className:"active-membership",children:[e.jsxs("div",{className:"membership-header",children:[e.jsxs("div",{className:"status-indicator active",children:[e.jsxs("svg",{width:"20",height:"20",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[e.jsx("path",{d:"M9 12l2 2 4-4"}),e.jsx("circle",{cx:"12",cy:"12",r:"9"})]}),e.jsx("span",{children:"Active Membership"})]}),e.jsx("div",{className:"membership-type",children:r.activeBookings[0].membershipType})]}),e.jsxs("div",{className:"membership-details",children:[e.jsxs("div",{className:"detail-row",children:[e.jsx("span",{className:"detail-label",children:"Duration:"}),e.jsx("span",{className:"detail-value",children:r.activeBookings[0].membershipDuration})]}),e.jsxs("div",{className:"detail-row",children:[e.jsx("span",{className:"detail-label",children:"Time Slot:"}),e.jsx("span",{className:"detail-value",children:r.activeBookings[0].timeSlot})]}),e.jsxs("div",{className:"detail-row",children:[e.jsx("span",{className:"detail-label",children:"Start Date:"}),e.jsx("span",{className:"detail-value",children:new Date(r.activeBookings[0].membershipStartDate).toLocaleDateString()})]}),e.jsxs("div",{className:"detail-row",children:[e.jsx("span",{className:"detail-label",children:"End Date:"}),e.jsx("span",{className:"detail-value",children:new Date(r.activeBookings[0].membershipEndDate).toLocaleDateString()})]}),r.activeBookings[0].preferredSeat&&e.jsxs("div",{className:"detail-row",children:[e.jsx("span",{className:"detail-label",children:"Preferred Seat:"}),e.jsx("span",{className:"detail-value",children:r.activeBookings[0].preferredSeat})]}),e.jsxs("div",{className:"detail-row",children:[e.jsx("span",{className:"detail-label",children:"Amount Paid:"}),e.jsxs("span",{className:"detail-value",children:["â‚¹",r.activeBookings[0].totalAmount]})]})]}),(()=>{const t=new Date(r.activeBookings[0].membershipStartDate),s=new Date(r.activeBookings[0].membershipEndDate),i=new Date;if(i.setHours(0,0,0,0),t.setHours(0,0,0,0),s.setHours(0,0,0,0),i<t){const l=Math.ceil((t-i)/864e5);return e.jsx("div",{className:"membership-action upcoming",children:e.jsxs("div",{className:"start-info",children:[e.jsxs("svg",{width:"20",height:"20",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[e.jsx("circle",{cx:"12",cy:"12",r:"10"}),e.jsx("polyline",{points:"12,6 12,12 16,14"})]}),l===1?"Starts tomorrow":`Starts in ${l} days`]})})}else{if(i>s)return e.jsxs("div",{className:"membership-action expired",children:[e.jsxs("div",{className:"expiry-notice",children:[e.jsxs("svg",{width:"20",height:"20",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[e.jsx("circle",{cx:"12",cy:"12",r:"10"}),e.jsx("line",{x1:"12",y1:"8",x2:"12",y2:"12"}),e.jsx("line",{x1:"12",y1:"16",x2:"12.01",y2:"16"})]}),"Expired"]}),e.jsx("button",{className:"renew-button",onClick:()=>n("/booking?renewal=true",{replace:!0}),children:"Renew Membership"})]});{const l=Math.ceil((s-i)/864e5);return l<=7?e.jsxs("div",{className:"membership-action expiring",children:[e.jsxs("div",{className:"expiry-notice",children:[e.jsxs("svg",{width:"20",height:"20",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[e.jsx("circle",{cx:"12",cy:"12",r:"10"}),e.jsx("line",{x1:"12",y1:"8",x2:"12",y2:"12"}),e.jsx("line",{x1:"12",y1:"16",x2:"12.01",y2:"16"})]}),l===1?"Expires today":`${l} days remaining`]}),e.jsx("button",{className:"renew-button",onClick:()=>n("/booking?renewal=true",{replace:!0}),children:"Renew Membership"})]}):e.jsx("div",{className:"membership-action active",children:e.jsxs("div",{className:"expiry-info",children:[e.jsxs("svg",{width:"20",height:"20",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[e.jsx("path",{d:"M9 12l2 2 4-4"}),e.jsx("circle",{cx:"12",cy:"12",r:"9"})]}),l," days remaining"]})})}}})()]}):a.bookingDetails&&(a.bookingDetails.paymentStatus==="pending"||a.bookingDetails.paymentStatus==="cash_pending")?e.jsxs("div",{className:"pending-membership",children:[e.jsxs("div",{className:"status-indicator pending",children:[e.jsxs("svg",{width:"20",height:"20",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[e.jsx("circle",{cx:"12",cy:"12",r:"10"}),e.jsx("line",{x1:"12",y1:"8",x2:"12",y2:"12"}),e.jsx("line",{x1:"12",y1:"16",x2:"12.01",y2:"16"})]}),e.jsx("span",{children:a.bookingDetails.paymentStatus==="cash_pending"?"Cash Payment Pending Collection":"Payment Pending"})]}),e.jsx("p",{className:"membership-message",children:a.bookingDetails.paymentStatus==="cash_pending"?"Your cash payment request has been submitted. An admin will contact you to collect the payment. You will receive your Dyanpitt ID after payment collection.":"Your membership booking is pending payment completion."}),a.bookingDetails.paymentStatus==="cash_pending"?e.jsx("button",{className:"complete-payment-button",onClick:()=>n("/cash-payment-pending",{state:{bookingData:a.bookingDetails}}),children:"View Payment Status"}):e.jsx("button",{className:"complete-payment-button",onClick:()=>n("/payment",{replace:!0}),children:"Complete Payment"})]}):e.jsxs("div",{className:"no-membership",children:[e.jsxs("div",{className:"status-indicator inactive",children:[e.jsxs("svg",{width:"20",height:"20",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[e.jsx("circle",{cx:"12",cy:"12",r:"10"}),e.jsx("line",{x1:"15",y1:"9",x2:"9",y2:"15"}),e.jsx("line",{x1:"9",y1:"9",x2:"15",y2:"15"})]}),e.jsx("span",{children:"No Active Membership"})]}),e.jsx("p",{className:"membership-message",children:"You don't have an active membership yet. Get started by purchasing a membership plan."}),e.jsx("button",{className:"get-membership-button",onClick:()=>{a.membershipCompleted?n("/booking",{replace:!0}):n("/membership-details",{replace:!0})},children:a.membershipCompleted?"Purchase Membership":"Complete Profile & Get Membership"})]})})]}),a&&r?.hasActiveMembership&&r?.activeBookings?.length>0&&e.jsxs("div",{className:"qr-container",children:[e.jsxs("div",{className:"qr-left-side",children:[e.jsxs("div",{className:"scan-me-text",children:[e.jsx("h4",{children:"Scan Me"}),e.jsx("p",{children:"Show this QR code at the entrance for quick access to your study room."})]}),e.jsxs("button",{className:"download-qr-button",onClick:E,children:[e.jsxs("svg",{width:"20",height:"20",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[e.jsx("path",{d:"M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"}),e.jsx("polyline",{points:"7,10 12,15 17,10"}),e.jsx("line",{x1:"12",y1:"15",x2:"12",y2:"3"})]}),"Download QR Pass"]})]}),e.jsx("div",{className:"qr-right-side",children:e.jsx("div",{className:"qr-code-display",children:p?e.jsx("img",{src:p,alt:"Membership Pass QR Code",className:"qr-code-image",style:{width:"200px",height:"200px",border:"2px solid #e2e8f0",borderRadius:"8px"}}):e.jsx("div",{style:{width:"200px",height:"200px",border:"2px solid #e2e8f0",borderRadius:"8px",display:"flex",alignItems:"center",justifyContent:"center",backgroundColor:"#f8fafc",color:"#64748b"},children:"Generating QR Code..."})})})]}),e.jsxs("div",{className:"dashboard-profile-section",children:[e.jsx("h3",{className:"section-title",children:"Profile Picture"}),e.jsxs("div",{className:"profile-upload-container",children:[e.jsx("div",{className:"current-profile-display",children:e.jsx("div",{className:"dashboard-profile-picture",children:a?.avatar&&!f?e.jsx("img",{src:`${y}${a.avatar}`,alt:"Current Profile",className:"dashboard-current-profile-image",onError:j,crossOrigin:"anonymous"}):a?.fullName?a.fullName.charAt(0).toUpperCase():"U"})}),e.jsxs("div",{className:"profile-upload-controls",children:[e.jsxs("div",{className:"file-upload-container",children:[e.jsx("input",{type:"file",name:"profilePicture",accept:"image/*",onChange:P,className:"file-input-hidden",id:"dashboardProfilePicture"}),e.jsxs("label",{htmlFor:"dashboardProfilePicture",className:`file-upload-button ${u.profilePicture?"input-error":""}`,children:[e.jsxs("svg",{width:"20",height:"20",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[e.jsx("path",{d:"M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"}),e.jsx("circle",{cx:"12",cy:"13",r:"4"})]}),a?.avatar?"Change Picture":"Upload Profile Picture"]})]}),u.profilePicture&&e.jsx("span",{className:"error-message",children:u.profilePicture})]})]})]}),e.jsx("div",{className:"dashboard-placeholder",children:a?.hasDnyanpittId?e.jsxs("div",{className:"membership-actions",children:[e.jsx("h3",{children:"Membership Options"}),r?e.jsx("div",{className:"membership-status",children:r.hasActiveMembership?e.jsxs("div",{className:"active-membership-notice",children:[e.jsx("p",{children:"âœ… You have an active membership!"}),e.jsx("p",{children:"Only one active membership is allowed at a time."})]}):e.jsxs("div",{className:"new-membership-option",children:[e.jsx("p",{children:"Welcome back! You can renew your membership."}),e.jsx("button",{onClick:A,className:"renew-membership-button",children:"Renew Membership"})]})}):e.jsx("p",{children:"Checking membership status..."})]}):e.jsxs("div",{children:[e.jsx("p",{children:"This is a placeholder dashboard page."}),e.jsx("p",{children:"More features will be added here in the future."})]})})]})}),e.jsx("div",{className:"dashboard-footer",children:e.jsx("button",{onClick:M,className:"logout-button",children:"Logout"})})]})}export{L as default};
