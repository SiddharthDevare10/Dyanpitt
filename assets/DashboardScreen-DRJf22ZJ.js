import{r,j as e,c as n}from"./index-DJTMSaIU.js";import{Q as I}from"./browser-DFX9LUgJ.js";import{v as R}from"./fileValidation-Bv-3PqZU.js";const T="http://localhost:5000/api",v=T.replace("/api","");function F(){const[s,u]=r.useState(null),[y,N]=r.useState(!0),[p,o]=r.useState({}),[f,g]=r.useState(!1),[c,w]=r.useState(""),[d,k]=r.useState(null);r.useEffect(()=>{(async()=>{try{const i=await n.getCurrentUser();if(i.success)u(i.user),i.user.hasDnyanpittId&&await D();else throw new Error("Failed to fetch user data")}catch(i){console.error("Error loading user data:",i),n.removeToken(),window.location.href="/"}finally{N(!1)}})()},[]);const D=async()=>{try{const a=await n.get("/booking/check-eligibility");a.success&&k(a.data)}catch(a){console.error("Error checking membership eligibility:",a)}},S=()=>{d?.canCreateNewMembership?window.location.href="/membership":d?.hasActiveMembership&&alert("You already have an active membership. Only one active membership is allowed at a time.")},P=async a=>{const i=a.target.files[0];if(!i)return;const t=R(i,"AVATAR");if(!t.isValid){o(l=>({...l,profilePicture:t.error})),a.target.value="";return}o(l=>({...l,profilePicture:""}));try{const l=await n.uploadAvatar(i);l.success?u(l.user):o(h=>({...h,profilePicture:l.message||"Failed to upload avatar"}))}catch(l){console.error("Error uploading avatar:",l),o(h=>({...h,profilePicture:l.message||"Error uploading avatar. Please try again."}))}},j=()=>{g(!0)};r.useEffect(()=>{g(!1)},[s?.avatar]),r.useEffect(()=>{s&&s.bookingDetails&&s.bookingDetails.paymentStatus==="completed"&&A(s)},[s?.bookingDetails?.paymentStatus,s?.dyanpittId,s?.fullName]);const A=async a=>{try{const i={type:"MEMBERSHIP_PASS",id:a.dyanpittId||a.email,name:a.fullName,email:a.email,membership:a.bookingDetails.membershipType,timeSlot:a.bookingDetails.timeSlot,validFrom:a.bookingDetails.membershipStartDate,validUntil:a.bookingDetails.membershipEndDate,seat:a.bookingDetails.preferredSeat||"Any",generatedAt:new Date().toISOString(),status:"active"},t=await I.toDataURL(JSON.stringify(i),{width:200,margin:2,color:{dark:"#000000",light:"#FFFFFF"}});w(t)}catch(i){console.error("Error generating QR code:",i)}},C=async()=>{if(!(!c||!s))try{const a=document.createElement("canvas"),i=a.getContext("2d");a.width=800,a.height=1200,i.fillStyle="#ffffff",i.fillRect(0,0,a.width,a.height),i.fillStyle="#1e293b",i.font="bold 32px Arial",i.textAlign="center",i.fillText("DYANPITT MEMBERSHIP PASS",a.width/2,60),i.font="18px Arial",i.fillStyle="#64748b",i.fillText("Study Room Access Pass",a.width/2,90);let t=150;i.fillStyle="#1e293b",i.font="bold 24px Arial",i.textAlign="left",i.fillText("Member Information",50,t),t+=40,i.font="16px Arial",i.fillStyle="#374151",[`Name: ${s.fullName}`,`Email: ${s.email}`,...s.dyanpittId?[`Dyanpeeth Abhyasika ID: ${s.dyanpittId}`]:[],...s.phoneNumber?[`Phone: ${s.phoneNumber}`]:[]].forEach(m=>{i.fillText(m,50,t),t+=25}),t+=20,i.fillStyle="#1e293b",i.font="bold 24px Arial",i.fillText("Membership Details",50,t),t+=40,i.font="16px Arial",i.fillStyle="#374151",[`Type: ${s.bookingDetails.membershipType}`,`Duration: ${s.bookingDetails.membershipDuration}`,`Time Slot: ${s.bookingDetails.timeSlot}`,`Valid From: ${new Date(s.bookingDetails.membershipStartDate).toLocaleDateString()}`,`Valid Until: ${new Date(s.bookingDetails.membershipEndDate).toLocaleDateString()}`,...s.bookingDetails.preferredSeat?[`Preferred Seat: ${s.bookingDetails.preferredSeat}`]:[],`Amount Paid: ₹${s.bookingDetails.totalAmount}`].forEach(m=>{i.fillText(m,50,t),t+=25}),t+=40;const x=new Image;x.onload=()=>{const M=(a.width-200)/2;i.drawImage(x,M,t,200,200),t+=230,i.fillStyle="#1e293b",i.font="bold 18px Arial",i.textAlign="center",i.fillText("Scan for Verification",a.width/2,t),t+=40,i.font="14px Arial",i.fillStyle="#64748b",i.fillText("Present this pass at the entrance for access",a.width/2,t),t+=20,i.fillText("Show QR code to staff for verification",a.width/2,t),t+=60,i.fillStyle="#9ca3af",i.font="12px Arial",i.fillText(`Generated on: ${new Date().toLocaleString()}`,a.width/2,t);const b=document.createElement("a");b.download=`dyanpitt-membership-pass-${s.dyanpittId||s.email}.png`,b.href=a.toDataURL(),b.click()},x.src=c}catch(a){console.error("Error generating membership pass:",a)}},E=async()=>{try{await n.logout(),window.location.href="/"}catch{n.removeToken(),window.location.href="/"}};return y?e.jsx("div",{className:"main-container",children:e.jsx("div",{className:"simple-loading",children:e.jsx("p",{children:"Loading..."})})}):e.jsxs("div",{className:"dashboard-container",children:[e.jsxs("div",{className:"dashboard-header",children:[e.jsx("div",{className:"profile-picture-container",children:e.jsx("div",{className:"profile-picture",children:s?.avatar&&!f?e.jsx("img",{src:`${v}${s.avatar}`,alt:"Profile",className:"dashboard-profile-image",onError:j,crossOrigin:"anonymous"}):s?.fullName?s.fullName.charAt(0).toUpperCase():"U"})}),e.jsxs("div",{className:"header-text-section",children:[e.jsx("div",{className:"welcome-message",children:"Welcome!"}),e.jsx("div",{className:"user-name",children:s?.fullName||"User"})]})]}),e.jsx("div",{className:"dashboard-content",children:e.jsxs("div",{className:"dashboard-welcome-section",children:[s&&e.jsxs("div",{className:"dashboard-user-card",children:[e.jsx("h3",{className:"user-card-title",children:"Your Account Details"}),e.jsxs("div",{className:"user-details",children:[e.jsxs("div",{className:"user-detail-item",children:[e.jsx("span",{className:"detail-label",children:"Full Name:"}),e.jsx("span",{className:"detail-value",children:s.fullName})]}),e.jsxs("div",{className:"user-detail-item",children:[e.jsx("span",{className:"detail-label",children:"Email:"}),e.jsx("span",{className:"detail-value",children:s.email})]}),e.jsxs("div",{className:"user-detail-item",children:[e.jsx("span",{className:"detail-label",children:"Dyanpeeth Abhyasika ID:"}),s.hasDnyanpittId?e.jsx("span",{className:"detail-value dyanpitt-id",children:s.dyanpittId}):e.jsx("span",{className:"detail-value pending-id",children:"Pending - Complete membership & payment to get your ID"})]}),s.phoneNumber&&e.jsxs("div",{className:"user-detail-item",children:[e.jsx("span",{className:"detail-label",children:"Phone:"}),e.jsx("span",{className:"detail-value",children:s.phoneNumber})]})]})]}),s&&e.jsxs("div",{className:"dashboard-membership-section",children:[e.jsx("h3",{className:"section-title",children:"Membership Status"}),e.jsx("div",{className:"membership-status-card",children:s.bookingDetails&&(s.bookingDetails.paymentStatus==="completed"||s.bookingDetails.paymentStatus==="cash_collected")?e.jsxs("div",{className:"active-membership",children:[e.jsxs("div",{className:"membership-header",children:[e.jsxs("div",{className:"status-indicator active",children:[e.jsxs("svg",{width:"20",height:"20",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[e.jsx("path",{d:"M9 12l2 2 4-4"}),e.jsx("circle",{cx:"12",cy:"12",r:"9"})]}),e.jsx("span",{children:"Active Membership"})]}),e.jsx("div",{className:"membership-type",children:s.bookingDetails.membershipType})]}),e.jsxs("div",{className:"membership-details",children:[e.jsxs("div",{className:"detail-row",children:[e.jsx("span",{className:"detail-label",children:"Duration:"}),e.jsx("span",{className:"detail-value",children:s.bookingDetails.membershipDuration})]}),e.jsxs("div",{className:"detail-row",children:[e.jsx("span",{className:"detail-label",children:"Time Slot:"}),e.jsx("span",{className:"detail-value",children:s.bookingDetails.timeSlot})]}),e.jsxs("div",{className:"detail-row",children:[e.jsx("span",{className:"detail-label",children:"Start Date:"}),e.jsx("span",{className:"detail-value",children:new Date(s.bookingDetails.membershipStartDate).toLocaleDateString()})]}),e.jsxs("div",{className:"detail-row",children:[e.jsx("span",{className:"detail-label",children:"End Date:"}),e.jsx("span",{className:"detail-value",children:new Date(s.bookingDetails.membershipEndDate).toLocaleDateString()})]}),s.bookingDetails.preferredSeat&&e.jsxs("div",{className:"detail-row",children:[e.jsx("span",{className:"detail-label",children:"Preferred Seat:"}),e.jsx("span",{className:"detail-value",children:s.bookingDetails.preferredSeat})]}),e.jsxs("div",{className:"detail-row",children:[e.jsx("span",{className:"detail-label",children:"Amount Paid:"}),e.jsxs("span",{className:"detail-value",children:["₹",s.bookingDetails.totalAmount]})]})]}),(()=>{const a=new Date(s.bookingDetails.membershipEndDate),t=Math.ceil((a-new Date)/(1e3*60*60*24));return t<=0?e.jsxs("div",{className:"membership-action expired",children:[e.jsxs("div",{className:"expiry-notice",children:[e.jsxs("svg",{width:"20",height:"20",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[e.jsx("circle",{cx:"12",cy:"12",r:"10"}),e.jsx("line",{x1:"12",y1:"8",x2:"12",y2:"12"}),e.jsx("line",{x1:"12",y1:"16",x2:"12.01",y2:"16"})]}),"Your membership has expired"]}),e.jsx("button",{className:"renew-button",onClick:()=>window.location.href="/booking?renewal=true",children:"Renew Membership"})]}):t<=7?e.jsxs("div",{className:"membership-action expiring",children:[e.jsxs("div",{className:"expiry-notice",children:[e.jsxs("svg",{width:"20",height:"20",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[e.jsx("circle",{cx:"12",cy:"12",r:"10"}),e.jsx("line",{x1:"12",y1:"8",x2:"12",y2:"12"}),e.jsx("line",{x1:"12",y1:"16",x2:"12.01",y2:"16"})]}),"Expires in ",t," day",t!==1?"s":""]}),e.jsx("button",{className:"renew-button",onClick:()=>window.location.href="/booking?renewal=true",children:"Renew Membership"})]}):e.jsx("div",{className:"membership-action active",children:e.jsxs("div",{className:"expiry-info",children:[e.jsxs("svg",{width:"20",height:"20",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[e.jsx("path",{d:"M9 12l2 2 4-4"}),e.jsx("circle",{cx:"12",cy:"12",r:"9"})]}),t," days remaining"]})})})()]}):s.bookingDetails&&(s.bookingDetails.paymentStatus==="pending"||s.bookingDetails.paymentStatus==="cash_pending")?e.jsxs("div",{className:"pending-membership",children:[e.jsxs("div",{className:"status-indicator pending",children:[e.jsxs("svg",{width:"20",height:"20",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[e.jsx("circle",{cx:"12",cy:"12",r:"10"}),e.jsx("line",{x1:"12",y1:"8",x2:"12",y2:"12"}),e.jsx("line",{x1:"12",y1:"16",x2:"12.01",y2:"16"})]}),e.jsx("span",{children:s.bookingDetails.paymentStatus==="cash_pending"?"Cash Payment Pending Collection":"Payment Pending"})]}),e.jsx("p",{className:"membership-message",children:s.bookingDetails.paymentStatus==="cash_pending"?"Your cash payment request has been submitted. An admin will contact you to collect the payment. You will receive your Dyanpitt ID after payment collection.":"Your membership booking is pending payment completion."}),s.bookingDetails.paymentStatus!=="cash_pending"&&e.jsx("button",{className:"complete-payment-button",onClick:()=>window.location.href="/payment",children:"Complete Payment"})]}):e.jsxs("div",{className:"no-membership",children:[e.jsxs("div",{className:"status-indicator inactive",children:[e.jsxs("svg",{width:"20",height:"20",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[e.jsx("circle",{cx:"12",cy:"12",r:"10"}),e.jsx("line",{x1:"15",y1:"9",x2:"9",y2:"15"}),e.jsx("line",{x1:"9",y1:"9",x2:"15",y2:"15"})]}),e.jsx("span",{children:"No Active Membership"})]}),e.jsx("p",{className:"membership-message",children:"You don't have an active membership yet. Get started by purchasing a membership plan."}),e.jsx("button",{className:"get-membership-button",onClick:()=>{s.membershipCompleted?window.location.href="/booking":window.location.href="/membership-details"},children:s.membershipCompleted?"Purchase Membership":"Complete Profile & Get Membership"})]})})]}),s&&s.bookingDetails&&s.bookingDetails.paymentStatus==="completed"&&e.jsxs("div",{className:"qr-container",children:[e.jsxs("div",{className:"qr-left-side",children:[e.jsxs("div",{className:"scan-me-text",children:[e.jsx("h4",{children:"Scan Me"}),e.jsx("p",{children:"Show this QR code at the entrance for quick access to your study room."})]}),e.jsxs("button",{className:"download-qr-button",onClick:C,children:[e.jsxs("svg",{width:"20",height:"20",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[e.jsx("path",{d:"M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"}),e.jsx("polyline",{points:"7,10 12,15 17,10"}),e.jsx("line",{x1:"12",y1:"15",x2:"12",y2:"3"})]}),"Download QR Pass"]})]}),e.jsx("div",{className:"qr-right-side",children:e.jsx("div",{className:"qr-code-display",children:c?e.jsx("img",{src:c,alt:"Membership Pass QR Code",className:"qr-code-image",style:{width:"200px",height:"200px",border:"2px solid #e2e8f0",borderRadius:"8px"}}):e.jsx("div",{style:{width:"200px",height:"200px",border:"2px solid #e2e8f0",borderRadius:"8px",display:"flex",alignItems:"center",justifyContent:"center",backgroundColor:"#f8fafc",color:"#64748b"},children:"Generating QR Code..."})})})]}),e.jsxs("div",{className:"dashboard-profile-section",children:[e.jsx("h3",{className:"section-title",children:"Profile Picture"}),e.jsxs("div",{className:"profile-upload-container",children:[e.jsx("div",{className:"current-profile-display",children:e.jsx("div",{className:"dashboard-profile-picture",children:s?.avatar&&!f?e.jsx("img",{src:`${v}${s.avatar}`,alt:"Current Profile",className:"dashboard-current-profile-image",onError:j,crossOrigin:"anonymous"}):s?.fullName?s.fullName.charAt(0).toUpperCase():"U"})}),e.jsxs("div",{className:"profile-upload-controls",children:[e.jsxs("div",{className:"file-upload-container",children:[e.jsx("input",{type:"file",name:"profilePicture",accept:"image/*",onChange:P,className:"file-input-hidden",id:"dashboardProfilePicture"}),e.jsxs("label",{htmlFor:"dashboardProfilePicture",className:`file-upload-button ${p.profilePicture?"input-error":""}`,children:[e.jsxs("svg",{width:"20",height:"20",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[e.jsx("path",{d:"M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"}),e.jsx("circle",{cx:"12",cy:"13",r:"4"})]}),s?.avatar?"Change Picture":"Upload Profile Picture"]})]}),p.profilePicture&&e.jsx("span",{className:"error-message",children:p.profilePicture})]})]})]}),e.jsx("div",{className:"dashboard-placeholder",children:s?.hasDnyanpittId?e.jsxs("div",{className:"membership-actions",children:[e.jsx("h3",{children:"Membership Options"}),d?e.jsx("div",{className:"membership-status",children:d.hasActiveMembership?e.jsxs("div",{className:"active-membership-notice",children:[e.jsx("p",{children:"✅ You have an active membership!"}),e.jsx("p",{children:"Only one active membership is allowed at a time."})]}):e.jsxs("div",{className:"new-membership-option",children:[e.jsx("p",{children:"Welcome back! You can renew your membership."}),e.jsx("button",{onClick:S,className:"renew-membership-button",children:"Renew Membership"})]})}):e.jsx("p",{children:"Checking membership status..."})]}):e.jsxs("div",{children:[e.jsx("p",{children:"This is a placeholder dashboard page."}),e.jsx("p",{children:"More features will be added here in the future."})]})})]})}),e.jsx("div",{className:"dashboard-footer",children:e.jsx("button",{onClick:E,className:"logout-button",children:"Logout"})})]})}export{F as default};
